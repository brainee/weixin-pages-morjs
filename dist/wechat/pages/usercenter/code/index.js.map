{"version":3,"file":"pages/usercenter/code/index.js","mappings":";;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;ACtQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack:///./pages/usercenter/code/index.js","webpack:///./services/usercenter/smsService.js"],"sourcesContent":["import { __awaiter, __generator } from \"tslib\";\n// pages/usercenter/validate-code/index.ts\nimport { getCurrentPageParam } from '../../../utils/queryString';\nimport { wxLogin, } from '../../../services/usercenter/loginService';\nimport { getSmsSession, sendSmsCodeService, validateSmsService, } from '../../../services/usercenter/smsService';\nimport { config } from '../../../config/index';\nvar default_mobile_prefix = config.default_mobile_prefix;\nvar default_sendsms_time = config.default_sendsms_time;\nPage({\n    /**\n     * 页面的初始数据\n     */\n    data: {\n        account: \"\",\n        isFocus: true,\n        code: \"\",\n        isRegain: false,\n        timer: null,\n        time: default_sendsms_time,\n        leftSendTimes: 2,\n        stepDisabled: true,\n        validatedToken: \"\",\n    },\n    /* 生命周期函数--监听页面加载 */\n    onLoad: function (options) {\n        var _this = this;\n        var _a;\n        // console.log(\"[zy]options=\",options);\n        var _b = getCurrentPageParam() || {}, account = _b.account, operate = _b.operate;\n        console.log(\"[zy]got from last page:account\", account);\n        this.setData({\n            account: account,\n            operate: operate\n        });\n        var mobile = account;\n        var mobileprefix = default_mobile_prefix;\n        var App = getApp();\n        var _c = (_a = App === null || App === void 0 ? void 0 : App.globalData) === null || _a === void 0 ? void 0 : _a.session, openid = _c.openid, unionid = _c.unionid;\n        sendSmsCodeService({\n            openid: openid,\n            unionid: unionid,\n            mobile: mobile,\n            mobileprefix: mobileprefix\n        }).then(function (e) {\n            var _a = e || {}, returnCode = _a.returnCode, maxSendTimes = _a.maxSendTimes, message = _a.message, leftSendTimes = _a.leftSendTimes;\n            _this.setData({\n                leftSendTimes: leftSendTimes,\n            });\n            if (returnCode === 0) {\n                _this.countdown();\n            }\n            else {\n                wx.showToast({ title: message || \"验证码发送失败，请重试\" });\n                _this.setData({\n                    isRegain: true,\n                });\n            }\n            console.log(\"[zy]onLoad e\", e);\n        });\n    },\n    validateParam: function () {\n        var _a;\n        var mobile = this.data.account;\n        var mobileprefix = default_mobile_prefix;\n        var smsCode = this.data.code;\n        var App = getApp();\n        var _b = (_a = App === null || App === void 0 ? void 0 : App.globalData) === null || _a === void 0 ? void 0 : _a.session, openid = _b.openid, unionid = _b.unionid;\n        if (!mobile) {\n            wx.showToast({\n                icon: 'none',\n                title: \"账号不能为空\",\n            });\n            return;\n        }\n        if (!smsCode) {\n            wx.showToast({\n                icon: 'none',\n                title: \"验证码不能为空\",\n            });\n            return;\n        }\n        if (!openid) {\n            wx.showToast({\n                icon: 'none',\n                title: \"需要先登录小程序\",\n            });\n            wxLogin();\n            return;\n        }\n        return true;\n    },\n    finishCode: function () {\n        if (!this.validateParam()) {\n            return;\n        }\n        var operate = this.data.operate;\n        if ([\"register\", \"reset\"].indexOf(operate) > -1) {\n            this.validateSmsCode();\n        }\n        else { //login\n            this.login();\n        }\n    },\n    login: function () {\n        var _a, _b, _c, _d;\n        return __awaiter(this, void 0, void 0, function () {\n            var mobile, mobileprefix, smsCode, App, _e, openid, unionid, res;\n            return __generator(this, function (_f) {\n                switch (_f.label) {\n                    case 0:\n                        mobile = this.data.account;\n                        mobileprefix = default_mobile_prefix;\n                        smsCode = this.data.code;\n                        App = getApp();\n                        _e = (_a = App === null || App === void 0 ? void 0 : App.globalData) === null || _a === void 0 ? void 0 : _a.session, openid = _e.openid, unionid = _e.unionid;\n                        return [4 /*yield*/, getSmsSession({\n                                openid: openid,\n                                unionid: unionid,\n                                mobile: mobile,\n                                smsCode: smsCode,\n                                mobileprefix: mobileprefix\n                            })];\n                    case 1:\n                        res = _f.sent();\n                        if ((_b = res === null || res === void 0 ? void 0 : res.loginResponse) === null || _b === void 0 ? void 0 : _b.flag) {\n                            wx.switchTab({ url: '/pages/cart/index' });\n                        }\n                        else if ((_c = res === null || res === void 0 ? void 0 : res.loginResponse) === null || _c === void 0 ? void 0 : _c.errorMsg) {\n                            wx.showToast({ title: (_d = res === null || res === void 0 ? void 0 : res.loginResponse) === null || _d === void 0 ? void 0 : _d.errorMsg });\n                        }\n                        else {\n                            wx.showToast({ title: \"登录失败，请检查手机号码和验证码\" });\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    },\n    validateSmsCode: function () {\n        var _a;\n        return __awaiter(this, void 0, void 0, function () {\n            var operate, mobile, mobileprefix, smsCode, App, _b, openid, unionid, res;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        operate = this.data.operate;\n                        mobile = this.data.account;\n                        mobileprefix = default_mobile_prefix;\n                        smsCode = this.data.code;\n                        App = getApp();\n                        _b = (_a = App === null || App === void 0 ? void 0 : App.globalData) === null || _a === void 0 ? void 0 : _a.session, openid = _b.openid, unionid = _b.unionid;\n                        return [4 /*yield*/, validateSmsService({\n                                openid: openid,\n                                unionid: unionid,\n                                mobile: mobile,\n                                smsCode: smsCode,\n                                mobileprefix: mobileprefix,\n                                operation: operate,\n                            })];\n                    case 1:\n                        res = _c.sent();\n                        if (res.returnCode === 0 && (res === null || res === void 0 ? void 0 : res.token)) { //data?.loginResponse?.token\n                            this.setData({\n                                stepDisabled: false,\n                                validatedToken: res === null || res === void 0 ? void 0 : res.token,\n                            });\n                        }\n                        else {\n                            wx.showToast({ title: (res === null || res === void 0 ? void 0 : res.message) || \"验证码失效\" });\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    },\n    goNext: function () {\n        var _a = this.data, account = _a.account, operate = _a.operate, validatedToken = _a.validatedToken;\n        if (validatedToken) {\n            if (operate === \"reset\") {\n                wx.navigateTo({ url: \"/pages/usercenter/reset/reset/index?account=\" + account + \"&token=\" + validatedToken + \"&operate=\" + operate });\n            }\n            else {\n                wx.navigateTo({ url: \"/pages/usercenter/register/pass/index?account=\" + account + \"&token=\" + validatedToken + \"&operate=\" + operate });\n            }\n        }\n        else {\n            wx.showToast({ title: \"验证码错误，请重新尝试\" });\n            this.setData({ code: \"\" });\n        }\n    },\n    regain: function () {\n        this.setData({\n            isRegain: false,\n        });\n        this.countdown();\n    },\n    switchPass: function () {\n        var account = this.data.account;\n        wx.navigateTo({ url: \"/pages/usercenter/login/pass/index?account=\" + account });\n    },\n    getFocus: function () {\n        this.setData({\n            isFocus: true,\n        });\n    },\n    getCode: function (e) {\n        console.log(\"[zy]getCode\", e);\n        var code = e.detail.value;\n        this.setData({\n            code: code,\n        });\n        if (code.length === 6) {\n            this.finishCode();\n        }\n    },\n    countdown: function () {\n        var _this = this;\n        var currentTime = this.data.time;\n        var timer = setInterval(function () {\n            currentTime--;\n            _this.setData({\n                time: currentTime\n            });\n            if (currentTime <= 0) {\n                clearInterval(timer);\n                _this.setData({\n                    time: default_sendsms_time,\n                    isRegain: true,\n                });\n            }\n        }, 1000);\n    },\n    /**\n     * 生命周期函数--监听页面显示\n     */\n    onShow: function () {\n    },\n    /**\n     * 生命周期函数--监听页面隐藏\n     */\n    onHide: function () {\n    },\n    /**\n     * 生命周期函数--监听页面卸载\n     */\n    onUnload: function () {\n    },\n    /**\n     * 页面相关事件处理函数--监听用户下拉动作\n     */\n    onPullDownRefresh: function () {\n    },\n    /**\n     * 页面上拉触底事件的处理函数\n     */\n    onReachBottom: function () {\n    },\n    /**\n     * 用户点击右上角分享\n     */\n    onShareAppMessage: function () {\n    }\n});\n","import { smsSession, sendSmsCode, validateSmsCode } from '../../model/usercenter/sessionModel';\nexport function getSmsSession(params) {\n    var prefix = \"[zy]getSmsSession\";\n    console.log(prefix, \"service start\");\n    return smsSession(params).then(function (data) {\n        var _a;\n        console.log(prefix, \"resp=\", data);\n        if (data) {\n            // let {mobile,openid,unionid,loginResponse:{flag,token,uid,errorMsg,}}=data;\n            if ((_a = data === null || data === void 0 ? void 0 : data.loginResponse) === null || _a === void 0 ? void 0 : _a.flag) {\n                getApp().globalData.session = data;\n            }\n            return data;\n        }\n    });\n}\nexport function sendSmsCodeService(params) {\n    var prefix = \"[zy]sendSmsCodeService\";\n    console.log(prefix, \"service start\", params);\n    return sendSmsCode(params).then(function (data) {\n        console.log(prefix, \"resp=\", data);\n        if (data) {\n            // let {mobile,openid,unionid,loginResponse:{flag,token,uid,errorMsg,}}=data;\n            return data;\n        }\n    });\n}\nexport function validateSmsService(params) {\n    var prefix = \"[zy]validateSmsService\";\n    console.log(prefix, \"service start\");\n    return validateSmsCode(params).then(function (data) {\n        console.log(prefix, \"resp=\", data);\n        if (data) {\n            // let {mobile,openid,unionid,loginResponse:{flag,token,uid,errorMsg,}}=data;\n            return data;\n        }\n    });\n}\n"],"names":[],"sourceRoot":""}